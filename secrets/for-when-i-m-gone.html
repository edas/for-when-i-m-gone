<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Au cas où il m'arrive quelque chose</title>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; script-src 'unsafe-inline'; style-src 'none'; style-src-elem 'unsafe-inline'; style-src-attr 'none'; img-src 'none'; connect-src 'none'; media-src 'none'; object-src 'none'; child-src 'none'; frame-src 'none'; worker-src 'none'; form-action 'none'; manifest-src 'none'">
    <style>
        main {
            max-width: 60ch;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.5rem;
        }

        .doc summary {
            font-weight: bold;
        }

        .doc summary::before {
            content: "ℹ️ "
        }

        .doc h2 {
            font-size: 1em;
        }

        .doc details {
            background-color: #bce3fe;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        form label {
            display: block;
        }

        form details p {
            margin: 0.5em 0;
        }

        form summary {
            color: #606060
        }

        form div.input {
            margin-bottom: 1.5rem;
        }

        form details>div {
            margin-left: 1rem;
            border-left: 1px solid #606060;
            padding-left: 1rem;
        }

        form input,
        form textarea {
            width: 100%;
            border-color: #B0B0B0;
            border-width: 1px;
            border-top: none;
            border-right: none;
        }

        button[type=submit],
        button.next {
            background-color: #bce3fe;
        }

        button.previous {
            background-color: white;
        }

        button {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border-style: solid;
            border-width: 1px;
            border-color: #606060;
            cursor: pointer;
        }

        button[type=submit]:disabled,
        button.next:disabled {
            background-color: #D0D0D0;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        div.input.submit {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        section[data-page] {
            display: none;
        }

        [data-current-step="1"] section[data-page="1"],
        [data-current-step="2"] section[data-page="2"],
        [data-current-step="3"] section[data-page="3"],
        [data-current-step="4"] section[data-page="4"] {
            display: block;
        }
    </style>
    <script src="../lib/ssss-js/bundle.ssss.js"></script>
</head>

<body>
    <noscript>
        <aside>
            <p>
                L'activation de Javascript est indispensable pour diviser le secret. Il existe toutefois une
                procédure manuelle sur <a
                    href="https://github.com/edas/for-when-i-m-gone">github.com/edas/for-when-i-m-gone</a> si vous
                préférez utiliser d'autres outils.
            </p>
        </aside>
    </noscript>
    <main>
        <article class="doc">
            <h1>Quel se passe-t-il s'il m'arrive quelque chose ?</h1>
            <details>
                <summary>À quoi ça sert tout ça ?</summary>
                <p>Je veux que mes proches puissent avoir accès à plein d'informations que je ne serai peut-être plus en
                    mesure
                    de leur donner, et entre autres les mots de passe et codes confidentiels des appareils ou des
                    comptes en
                    ligne.</p>
                <p>Je peux les écrire dans une lettre cachetée mais je ne sais pas ce qu'il peut advenir sur 10, 20 ou
                    40
                    ans.
                    Est-ce qu'il ne risque pas de se faire cambrioler avant ? d'être victime d'un piratage de son disque
                    dûr
                    ou
                    de ses données en ligne ? Est-ce qu'un tiers ne va pas abuser de sa confiance ou de sa négligence ?
                    Est-ce
                    que rien ne va nous diviser au point qu'il pourrait avoir envie d'utiliser ces informations
                    autrement
                    que de
                    la façon prévue ? 40 ans c'est long, même pour les personnes en qui j'ai le plus confiance sur tout
                    ça.
                    Même
                    alors, qui y aura accès si cette personne décède ?</p>
                <p>Il reste le dépôt d'un testament chez le notaire mais, même en ayant confiance en la confidentialité,
                    cette
                    solution me semble trop rigide. Si j'échoue à décrire précisément chaque situation spécifique
                    possible,
                    il
                    risque d'y avoir débat, temps d'attente, et une décision juridique qui n'est pas forcément celle que
                    j'aurais anticipé. Je préfère une évaluation subjective de la situation par des proches qui me
                    connaissent.
                </p>
                <h2>Un coffre-fort à plusieurs clefs</h2>
                <p>La solution elle est visible dans n'importe quel film d'espionnage ou de cambriolage : un coffre ou
                    une
                    mallette qui s'ouvre avec plusieurs clefs. Personne ne peut accéder seul au contenu. Il faut le
                    consensus de
                    différents détenteurs de clefs pour y accéder.</p>
                <p>Le secret de Shamir est un algorithme de cryptographie qui fait exactement ça : Il divise un secret
                    en
                    plusieurs parties en donnant à chaque participant une clef unique. Chaque clef ne donne accès à rien
                    mais
                    elles peuvent déverrouiller le secret quand elles sont mises ensemble. L'algorithme permet même de
                    définir
                    combien de clefs seront nécessaires parmi toutes celles qui existent. Dans notre cas ça permet de se
                    donner
                    10 clefs mais d'accepter que certaines soient perdues ou que leur détenteur soit injoignable.</p>
            </details>
            <p>Cette application va permettre de diviser vos informations confidentielles en plusieurs parties. Chaque
                partie sera constituée d'un document qui pourra être sauvegardé électroniquement ou imprimé sur papier.
                La
                procédure pour reconstituer le secret initial sera inclue dans chaque document en plus de <a
                    href="https://github.com/edas/for-when-i-m-gone">github.com/edas/for-when-i-m-gone</a>.</p>
        </article>
        <hr>

        <article class="app">
            <h1>Mise en œuvre</h1>
            <form class="split" id="generate" data-current-step="1">
                <input type="hidden" name="cipher" id="cipher" value="AES-GCM">
                <input type="hidden" name="length" id="length" value="256">
                <section data-page="1" id="step1">
                    <div class="input">
                        <label for="secret">Le secret</label>
                        <textarea name="secret" id="secret" rows="10" cols="50"
                            placeholder="Des choses secrètes à transmettre comme la clef de mon gestionnaire de mots de passe, les codes PIN et mon téléphone et de ma carte SIM pour avoir les codes d'authentification, le mot de passe de mon portable, et celui de mon compte email"
                            autocomplete="off" required minlength="1"></textarea>
                        <details>
                            <summary>Aide à propos du secret</summary>
                            <div>
                                <p>Il n'y a pas de limite ou de contrainte sur le secret. Mettez ce que vous voulez.</p>
                                <p>En pratique, la procédure est faite pour que les destinataires des différents
                                    documents
                                    puissent
                                    les
                                    imprimer
                                    sur papier en vue de leur conservation. Un secret de trop grande taille rendra très
                                    difficile la
                                    récupération de votre secret si aucun participant n'a gardé le document sous forme
                                    électronique.
                                    Pour
                                    garder
                                    cette possibilité ouverte, il est conseillé de garder le secret autour des 1000
                                    caractères.
                                </p>
                                <p>Pour permettre des changements ou ajouts simples de mots de passe, une bonne astuce
                                    est
                                    de
                                    stocker ses
                                    mots
                                    de passe dans un gestionnaire de mots de passe comme Bitwarden et de ne transmettre
                                    que
                                    la
                                    clef
                                    maitresse
                                    (qui elle ne devra pas changer sous peine de recommencer toute la procédure). En
                                    général
                                    on
                                    ajoute au
                                    moins
                                    le mot de passe du poste informatique, celui des emails, celui des sauvegardes,
                                    ainsi
                                    que les codes
                                    PIN
                                    du
                                    téléphone et de la carte SIM pour permettre de passer les authentifications à
                                    plusieurs
                                    facteurs.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input submit">
                        <div></div>
                        <button type="button" class=next data-to-step="2" id="step1next">Suite > Déterminer les
                            participants</button>
                    </div>
                </section>
                <section data-page="2" id="step2">
                    <div class="input">
                        <label for="quorum">Quorum pour reconstituer le secret</label>
                        <input type="number" min="2" name="quorum" id="quorum"
                            placeholder="Nombre de serrures sur le coffre" step="1" required>
                        <details>
                            <summary>Aide à propos du quorum</summary>
                            <div>
                                <p>Combien de personnes doivent-elles donner leur accord pour reconstituer le secret ?
                                </p>
                                <p>Plus le nombre est grand, plus il sera difficile pour une personne malveillante de
                                    dérober
                                    suffisamment de documents ou de convaincre suffisamment de participants pour
                                    reconstituer le
                                    secret d'origine. En échange, il faudra que beaucoup de monde arrive à se joindre et
                                    se
                                    synchroniser, ce qui peut prendre du temps.</p>
                                <p>Ce nombre sera connu de tous les participants.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input">
                        <label for="shares">Nombre de participants</label>
                        <input type="number" min="2" name="shares" id="shares" placeholder="Nombre de clefs distribuées"
                            step="1" required>
                        <details>
                            <summary>Aide à propos du nombre de participants</summary>
                            <div>
                                <p>Le nombre de participants ne peut pas être inférieur au quorum défini juste
                                    au-dessus.
                                    S'il
                                    est plus élevé, vous permettez que le secret soit reconstitué sans l'accord de tout
                                    le
                                    monde. C'est plutôt une bonne idée s'il s'agit que la procédure soit toujours
                                    utilisable
                                    dans 10, 20 ou 40 ans. D'ici là certaines personnes auront perdu leur document, ou
                                    auront
                                    mené leur vie ailleurs et ne seront pas forcément joignables. D'autres pourraient
                                    être
                                    décédées ou simplement ne plus être de bonne volonté.</p>
                                <p>Même si ce nombre a intérêt à être grand, n'intégrez que des personnes en qui vous
                                    avez
                                    totale confiance.</p>
                                <p>Le nombre total de participants ne sera pas donné aux différents participants. Rien
                                    ne
                                    vous
                                    empêche d'ajouter des personnes sans le dire à tous.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input">
                        <label for="participants">Liste des participants</label>
                        <textarea name="participants" id="participants" rows="10" cols="50" placeholder="Ma sœur Delphine, 0612121212, delphine@example.com
Mon avocat, Me Tartampion, 0612121212, avocat@example.com
Mon banquier, Paul Durant, 0612121212, banquier@example.com
Ma femme, Marie Dubois, 0612121212, femme@example.com"></textarea>
                        <details>
                            <summary>Aide à propos de la liste des participants</summary>
                            <div>
                                <p>S'il vous arrive quelque chose, quelqu'un devra joindre les différents participants
                                    pour
                                    obtenir le quorum suffisant. Qui doit-il joindre ? Ici vous pouvez laisser une liste
                                    avec
                                    noms, adresses, emails, téléphones ou toute autre coordonnée nécessaire. Rien ne
                                    vous
                                    oblige
                                    à lister tout le monde.</p>
                                <p>Cette liste sera en clair, visible de tous.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input submit">
                        <button type="button" class=previous data-to-step="1" id="step2previous">Précédent < Le
                                secret</button>
                                <button type="button" class=next data-to-step="3" id="step2next">Suite > Donner vos
                                    informations</button>
                    </div>
                </section>
                <section data-page="3" id="step3">
                    <div class="input">
                        <label for="name">Vous</label>
                        <input type="text" name="name" id="name" placeholder="Jean Dupont « avec un t »">
                        <details>
                            <summary>Aide à propos de votre nom</summary>
                            <div>
                                <p>Cette information permet d'identifier qui est la personne concernée par le secret
                                    (vous).
                                    Sans ça les participants vont avoir un document qu'ils ne sauront pas identifier.
                                </p>
                                <p>Préférez quelque chose de court (nom et prénom, pseudo) mais il n'y a pas de réelle
                                    contrainte.</p>
                                <p>Ces données seront en clair, visibles de tous.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input">
                        <label for="contact">Vous contacter</label>
                        <input type="text" name="contact" id="contact"
                            placeholder="jean.dupont@example.com, 0612121212, 3 rue de la Paix 75000 Paris">
                        <details>
                            <summary>Aide à propos de vos informations de contact</summary>
                            <div>
                                <p>Si quelqu'un se pose une question, le mieux est qu'il puisse essayer vous joindre
                                    avant
                                    d'initier quoi que ce soit. Ici vous pouvez laisser quelques points de contact
                                    (adresse
                                    postale, numéro de téléphone, adresse email, etc.)</p>
                                <p>Ces données seront en clair, visibles de tous.</p>
                            </div>
                        </details>
                    </div>

                    <div class="input">
                        <label for="instructions">Vos instructions</label>
                        <textarea name="instructions" id="instructions" rows="10" cols="50"
                            placeholder="En cas de décès, si je disparais sans prévenir et sans aucune nouvelle pendant une semaine malgré vos tentatives de contact, si j'ai un accident qui nécessite d'avoir accès à mes comptes et que je suis incapable de vous répondre. 

Merci de ne pas ouvrir ce coffre sans chercher à me joindre d'abord ou pour toute situation que j'aurai pu anticiper et que j'ai choisi de ne pas faire. "></textarea>
                        <details>
                            <summary>Aide à propos des instructions</summary>
                            <div>
                                <p>Si vous avez des instructions spécifiques pour reconstituer le secret, vous pouvez
                                    les
                                    laisser ici. Par exemple, vous pouvez préciser dans quelles conditions vous
                                    souhaitez
                                    que le
                                    secret soit révélé ou dans quelles conditions vous souhaitez qu'il ne le soit pas,
                                    éventuellement à qui.</p>
                                <p>Ces instructions seront en clair, visibles de tous.</p>
                            </div>
                        </details>
                    </div>
                    <div class="input submit">
                        <button type="button" class=previous data-to-step="2" id="step3previous">Précédent < Les
                                participants</button>
                                <button type="submit" class=submit id="step3next">Générer les documents</button>
                    </div>
                </section>
                <section data-page="4" id="step4">
                    <div role="status" id="status">Renseignez les informations du formulaire pour générer vos documents
                    </div>
                    <div class="input submit">
                        <button type="button" class=previous data-to-step="3" id="step4previous">Précédent < Vos
                                informations</button>
                    </div>
                </section>
            </form>
            <script id="generate-script">

                const byteToHexLookupTable = Array.from({ length: 256 }, (_, index) => index.toString(16).padStart(2, '0'));

                function bufferToHex(buff) {
                    let hexString = '';
                    const array = new Uint8Array(buff)
                    for (let index = 0; index < array.length; index++) {
                        hexString += byteToHexLookupTable[array[index]];
                    }
                    return hexString;
                }

                async function generateKey({ encryptionAlgorithm, encryptionKeyLength }) {
                    const keyType = { name: encryptionAlgorithm, length: encryptionKeyLength }
                    const extractable = true
                    const keyUsages = ["encrypt", "decrypt"]
                    const encryptionKey = await crypto.subtle.generateKey(keyType, extractable, keyUsages)
                    return encryptionKey
                }

                async function encryptSecret({ secret, encryptionKey, encryptionAlgorithm }) {
                    const iv = crypto.getRandomValues(new Uint8Array(96)); // for AES-GCM
                    const algorithm = { name: encryptionAlgorithm, iv };
                    const encodedSecret = new TextEncoder().encode(secret);
                    const encryptedData = await crypto.subtle.encrypt(algorithm, encryptionKey, encodedSecret);
                    return encryptedData
                }

                async function splitKey({ threshold, shares, encryptionKey }) {
                    const rawKey = await crypto.subtle.exportKey("raw", encryptionKey)  // ArrayBuffer
                    const hexKey = bufferToHex(rawKey)
                    const hexMode = true
                    const ssss = new SSSS(threshold, shares, hexMode);
                    const prefix = ''
                    const options = {}
                    const tokens = await ssss.split(hexKey, prefix, options);
                    return tokens
                }

                async function encrypt({ secret, shares, threshold, encryptionAlgorithm, encryptionKeyLength }) {
                    const encryptionKey = await generateKey({ encryptionAlgorithm, encryptionKeyLength })
                    const encryptedData = await encryptSecret({ secret, encryptionKey, encryptionAlgorithm })
                    const shamirTokens = (await splitKey({ threshold, shares, encryptionKey }))[0]
                    return {
                        encryptionAlgorithm,
                        encryptionKeyLength,
                        encryptedData,
                        shamirTokens,
                    }
                }

            </script>
            <script id="form-script">
                // STEP 1
                function validateSecret(element) {
                    const value = element.value.trim()
                    const length = value.length
                    const validity = element.validity
                    const valueMissing = validity.valueMissing
                    if (valueMissing || (length === 0)) {
                        element.setCustomValidity("Définir un secret est obligatoire. Tout ceci ne sert que si vous avez un secret à transmettre")
                        return false
                    }
                    element.setCustomValidity("")
                    return true
                }
                function onSecretChange(e) {
                    const element = e.target
                    validateSecret(element)
                    onStepChange()
                    element.reportValidity()
                }
                function validateStep1() {
                    const secret = document.getElementById('secret')
                    const secretValid = validateSecret(secret)
                    return secretValid
                }
                function checkStep1() {
                    const secret = document.getElementById('secret')
                    return secret.validity.valid
                }
                function goToStep2() {
                    goToStep(2)
                }
                function onStep1Init() {
                    const form = document.getElementById('generate')
                    const secret = document.getElementById('secret')
                    secret.addEventListener('input', onSecretChange)
                    const next = document.getElementById('step1next')
                    next.addEventListener('click', goToStep2)
                    validateStep1()
                    onStepChange()
                }
                // STEP 2
                function isValidityStateCorrectNumber(validity) {
                    const stepMismatch = validity.stepMismatch
                    const rangeOverflow = validity.rangeOverflow
                    const rangeUnderflow = validity.rangeUnderflow
                    const badInput = validity.badInput
                    const valueMissing = validity.valueMissing
                    const correctNumber = !badInput && !stepMismatch && !rangeOverflow && !rangeUnderflow && !valueMissing
                    return correctNumber
                }
                function validateQuorumAndShare({ quorum, shares, main }) {
                    const quorumValidity = quorum.validity
                    const sharesValidity = shares.validity
                    if (isValidityStateCorrectNumber(sharesValidity)) {
                        if (isValidityStateCorrectNumber(quorumValidity)) {
                            // check if shares is greater or equal to quorum
                            const sharesValue = shares.value
                            const sharesInt = parseInt(sharesValue)
                            const quorumValue = quorum.value
                            const quorumInt = parseInt(quorumValue)
                            if (sharesInt < quorumInt) {
                                const mainElement = main === 'quorum' ? quorum : shares
                                const secondaryElement = main === 'quorum' ? shares : quorum
                                mainElement.setCustomValidity("Le nombre de participants doit être supérieur ou égal au quorum")
                                secondaryElement.setCustomValidity("")
                            } else {
                                quorum.setCustomValidity("")
                                shares.setCustomValidity("")
                                return true
                            }
                        } else {
                            shares.setCustomValidity("")
                        }
                    } else if (isValidityStateCorrectNumber(quorumValidity)) {
                        quorum.setCustomValidity("")
                    }
                    return false
                }
                function onQuorumChange(e) {
                    const element = e.target
                    validateQuorum(element)
                    const shares = document.getElementById('shares')
                    validateQuorumAndShare({ quorum: element, shares, main: 'quorum' })
                    onStepChange()
                    element.reportValidity()
                }

                function validateQuorum(element) {
                    const validity = element.validity
                    const valueMissing = validity.valueMissing
                    if (isValidityStateCorrectNumber(validity)) {
                        element.setCustomValidity("")
                        return true
                    }
                    if (valueMissing) {
                        element.setCustomValidity("Un quorum est nécessaire pour reconstituer le secret")
                    } else {
                        element.setCustomValidity("Le quorum doit être un nombre entier supérieur à 1")
                    }
                    return false
                }
                function validateShares(element) {
                    const validity = element.validity
                    const valueMissing = validity.valueMissing
                    if (isValidityStateCorrectNumber(validity)) {
                        element.setCustomValidity("")
                        return true
                    }
                    if (valueMissing) {
                        element.setCustomValidity("Il est nécessaire de définir le nombre de participants")
                    } else {
                        element.setCustomValidity("Le nombre de participants doit être un nombre entier supérieur à 1")
                    }
                    return false

                }
                function onSharesChange(e) {
                    const element = e.target
                    validateShares(element)
                    const quorum = document.getElementById('quorum')
                    validateQuorumAndShare({ quorum, shares, main: 'shares' })
                    onStepChange()
                    element.reportValidity()
                }

                function validateStep2({ main } = { main: 'shares' }) {
                    const quorum = document.getElementById('quorum')
                    const quorumValid = validateQuorum(quorum)
                    const shares = document.getElementById('shares')
                    const sharesValid = validateShares(shares)
                    const sharesAndQuorumValid = validateQuorumAndShare({ quorum, shares, main })
                    return quorumValid && sharesValid && sharesAndQuorumValid
                }
                function checkStep2() {
                    const quorum = document.getElementById('quorum')
                    const shares = document.getElementById('shares')
                    const participants = document.getElementById('participants')
                    return quorum.validity.valid && shares.validity.valid && participants.validity.valid
                }
                function goToStep3() {
                    goToStep(3)
                }
                function goToStep1() {
                    goToStep(1)
                }
                function onStep2Init() {
                    const quorum = document.getElementById('quorum')
                    quorum.addEventListener('input', onQuorumChange)
                    const shares = document.getElementById('shares')
                    shares.addEventListener('input', onSharesChange)
                    const next = document.getElementById('step2next')
                    next.addEventListener('click', goToStep3)
                    const previous = document.getElementById('step2previous')
                    previous.addEventListener('click', goToStep1)
                    validateStep2()
                    onStepChange()
                }


                // STEP 3
                function checkStep3() {
                    return true
                }
                function goToStep4() {
                    goToStep(4)
                }
                function validateStep3() {
                    return true
                }
                function onStep3Init() {
                    const next = document.getElementById('step3next')
                    next.addEventListener('click', goToStep4)
                    const previous = document.getElementById('step3previous')
                    previous.addEventListener('click', goToStep2)
                    validateStep3()
                    onStepChange()
                }
                // STEP 4
                function checkStep4() {
                    return true
                }
                function returnToStep3() {
                    showResult("Renseignez les informations du formulaire pour générer vos documents.")
                    goToStep(3)
                }
                function onStep4Init() {
                    const previous = document.getElementById('step4previous')
                    previous.addEventListener('click', goToStep3)
                }
                // GENERAL FORM
                function onGenerateSubmit(e) {
                    e.preventDefault()
                    const secret = document.getElementById('secret').value.trim()
                    const shares = parseInt(document.getElementById('shares').value)
                    const threshold = parseInt(document.getElementById('quorum').value)
                    const encryptionAlgorithm = document.getElementById('cipher').value
                    const encryptionKeyLength = parseInt(document.getElementById('length').value)
                    showResult("Les documents sont en cours de génération. Patientez s'il vous plait.")
                    encrypt({ secret, shares, threshold, encryptionAlgorithm, encryptionKeyLength }).then(showResult).catch(showResult)
                }
                function showResult(msg) {
                    const status = document.getElementById('status')
                    status.textContent = msg

                }
                function onStepChange() {
                    const step1 = checkStep1()
                    const step2 = checkStep2()
                    const step3 = checkStep3()
                    setStepStatus(1, step1)
                    setStepStatus(2, step1 && step2)
                    setStepStatus(3, step1 && step2 && step3)
                }
                function setStepStatus(x, status) {
                    if (status) {
                        document.getElementById(`step${x}next`).removeAttribute('disabled')
                    } else {
                        document.getElementById(`step${x}next`).setAttribute('disabled', 'disabled')
                    }
                }
                function onGenerateInit() {
                    onStep1Init()
                    onStep2Init()
                    onStep3Init()
                    onStep4Init()
                    document.getElementById('generate').addEventListener('submit', onGenerateSubmit)
                }
                onGenerateInit()
                function goToStep(x) {
                    const form = document.getElementById('generate')
                    form.setAttribute('data-current-step', x)
                    const section = document.querySelector(`section[data-page="${x}"]`)
                    section.focus()
                }
            </script>
    </main>
</body>

</html>